**GozonShop - Асинхронная микросервисная система интернет-магазина**

**О проекте**
GozonShop - это система интернет-магазина, построенная на микросервисной архитектуре с асинхронным взаимодействием через RabbitMQ. Система реализует паттерны Transactional Outbox/Inbox для гарантированной доставки сообщений и обеспечения семантики "exactly-once" при обработке платежей.

**Требования**
Для запуска проекта необходимо установить следующее программное обеспечение:

.NET 8.0 SDK (https://dotnet.microsoft.com/download/dotnet/8.0)
Docker Desktop (https://www.docker.com/products/docker-desktop) или RabbitMQ (https://www.rabbitmq.com/download.html)
Visual Studio 2022 или Visual Studio Code
Postman или другой HTTP клиент для тестирования API

**Структура проекта**
Проект состоит из четырех компонентов. ApiGateway обеспечивает маршрутизацию запросов на порту 5000. OrdersService управляет заказами и работает на порту 5002. PaymentsService обрабатывает платежи и работает на порту 5003. Shared содержит общие типы сообщений для межсервисного взаимодействия.

**Запуск:**
1) Через Docker Compose:
cd GozonShop
docker-compose up -d
docker-compose ps


2) Через Visual Studio:

1. Перед запуском приложения необходимо запустить RabbitMQ. Откройте терминал и выполните команду:
docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management
Это запустит RabbitMQ в контейнере Docker с доступом к портам 5672 для AMQP и 15672 для веб-интерфейса управления.

2. Откройте файл решения GozonShop.sln в Visual Studio 2022. Настройте множественный запуск проектов, кликнув правой кнопкой мыши на решении и выбрав "Свойства". В разделе "Запуск" выберите "Несколько запускаемых проектов" и установите действие "Запустить" для ApiGateway, OrdersService и PaymentsService. Нажмите F5 или кнопку "Запустить" для запуска всех сервисов одновременно.

3. После успешного запуска откроется три консольных окна с логами каждого сервиса. API Gateway будет доступен по адресу https://localhost:7197/swagger/index.html, Orders Service по адресу https://localhost:7061/swagger/index.html, Payments Service по адресу https://localhost:7140/swagger/index.html.

4) Через командную строку
1. Откройте четыре терминала в корневой директории проекта. В первом терминале выполните команду: 
docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management - для запуска RabbitMQ.

Во втором терминале перейдите в директорию ApiGateway командой 
cd ApiGateway и запустите сервис командой dotnet run.

В третьем терминале перейдите в директорию OrdersService командой 
cd OrdersService и выполните dotnet run.

В четвертом терминале перейдите в директорию PaymentsService командой 
cd PaymentsService и выполните dotnet run.

2. Дождитесь сообщений о успешном запуске в каждом терминале. Теперь все сервисы работают и готовы к обработке запросов.

**Тестирование API**
1) Все запросы выполняются через API Gateway по адресу http://localhost:5000. Каждый запрос должен содержать заголовок X-User-Id с идентификатором пользователя.
2) Для создания счета выполните POST-запрос на http://localhost:5000/api/accounts с заголовком X-User-Id со значением user123. Сервис вернет идентификатор счета и начальный баланс 0.
3) Для пополнения счета выполните POST-запрос на http://localhost:5000/api/accounts/deposit с заголовком X-User-Id и телом запроса в формате JSON {"amount": 1000}. Сервис вернет обновленный баланс и идентификатор транзакции.
4) Для проверки баланса выполните GET-запрос на http://localhost:5000/api/accounts/balance с заголовком X-User-Id. Сервис вернет текущий баланс счета.
5) Для создания заказа выполните POST-запрос на http://localhost:5000/api/orders с заголовком X-User-Id и телом запроса {"amount": 250, "description": "Ноутбук"}. Сервис создаст заказ со статусом NEW и запустит асинхронный процесс оплаты.
6) Для просмотра статуса заказа выполните GET-запрос на http://localhost:5000/api/orders/{orderId} с заголовком X-User-Id, где orderId это идентификатор заказа из предыдущего ответа. Через несколько секунд статус изменится на FINISHED при успешной оплате или CANCELLED при недостатке средств.
7) Для просмотра всех заказов пользователя выполните GET-запрос на http://localhost:5000/api/orders с заголовком X-User-Id. Сервис вернет список всех заказов с информацией о сумме, описании и статусе.

**Проверка работы RabbitMQ**
1) Для просмотра состояния очередей откройте браузер и перейдите по адресу http://localhost:15672. Введите логин guest и пароль guest. В разделе Queues должны отображаться две очереди payment_requests и payment_results с информацией о количестве обработанных сообщений.
Остановка системы
2) Для остановки всех сервисов нажмите Ctrl+C в каждом терминале или закройте окна консоли. Для остановки RabbitMQ выполните команду docker stop rabbitmq и для удаления контейнера docker rm rabbitmq.

**Возможные проблемы**
Если сервисы не могут подключиться к RabbitMQ, проверьте что контейнер rabbitmq запущен командой docker ps. Если порты уже заняты, измените порты в файлах launchSettings.json каждого сервиса. Если возникают ошибки при работе с базой данных, убедитесь что у приложения есть права на запись в директорию проекта для создания файлов orders.db и payments.db.